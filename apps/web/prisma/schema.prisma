// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../../../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
}

enum UserRole {
  OWNER
  ADMIN
  STAFF
}

enum WorkOrderStatus {
  OPEN
  IN_PROGRESS
  DONE
  CANCELED
}

enum WorkOrderItemType {
  LABOR
  PART
}

enum PaymentMethod {
  CASH
  CARD
  TRANSFER
}

enum PaymentStatus {
  UNPAID
  PARTIAL
  PAID
}

enum WorkOrderEventType {
  STATUS_CHANGE
  PAYMENT_ADDED
}

enum CatalogItemType {
  PART
  SERVICE
}

enum InventoryMovementType {
  IN
  OUT
  ADJUST
}

enum InventoryReferenceType {
  PURCHASE
  WORK_ORDER
  MANUAL
}

enum PurchaseStatus {
  DRAFT
  ORDERED
  RECEIVED
  CANCELED
}

model User {
  id            String         @id @default(uuid())
  name          String?
  email         String         @unique
  emailVerified DateTime?
  image         String?
  passwordHash  String?
  role          UserRole       @default(OWNER)
  isActive      Boolean        @default(true)
  tenantId      String?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  refreshTokens RefreshToken[]
  accounts      Account[]
  sessions      Session[]
  customers     Customer[]
  vehicles      Vehicle[]
  workOrders    WorkOrder[]
  workOrderNotes WorkOrderNote[]
  payments      Payment[]
  cashCloses    CashClose[]
  workOrderEvents WorkOrderEvent[]
  inventoryMovements InventoryMovement[]

  @@index([tenantId])
}

model RefreshToken {
  id        String   @id
  userId    String
  tokenHash String
  revokedAt DateTime?
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Account {
  id                 String  @id @default(cuid())
  userId             String
  type               String
  provider           String
  providerAccountId  String
  refresh_token      String? @db.Text
  access_token       String? @db.Text
  expires_at         Int?
  token_type         String?
  scope              String?
  id_token           String? @db.Text
  session_state      String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Customer {
  id        String   @id @default(uuid())
  tenantId  String
  ownerId   String
  name      String
  email     String?
  phone     String?
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  owner     User        @relation(fields: [ownerId], references: [id])
  vehicles  Vehicle[]
  workOrders WorkOrder[]

  @@index([tenantId])
  @@index([ownerId])
}

model Vehicle {
  id        String   @id @default(uuid())
  tenantId  String
  ownerId   String
  customerId String
  plate     String
  brand     String?
  model     String?
  year      Int?
  fuel      String?
  transmission String?
  typeVehicle String?
  doors     Int?
  version   String?
  mileage   Int?
  vin       String?
  engineNo  String?
  color     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  owner    User     @relation(fields: [ownerId], references: [id])
  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  workOrders WorkOrder[]

  @@index([tenantId])
  @@index([ownerId])
  @@index([customerId])
  @@unique([tenantId, plate])
}

model WorkOrder {
  id          String          @id @default(uuid())
  tenantId    String
  ownerId     String
  customerId  String
  vehicleId   String?
  status      WorkOrderStatus
  paymentStatus PaymentStatus @default(UNPAID)
  title       String?
  description String?
  odometer    Int?
  totalCents  Int             @default(0)
  paidTotalCents Int          @default(0)
  balanceCents Int            @default(0)
  costTotalCents Int          @default(0)
  marginCents    Int          @default(0)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  owner    User     @relation(fields: [ownerId], references: [id])
  customer Customer @relation(fields: [customerId], references: [id])
  vehicle  Vehicle? @relation(fields: [vehicleId], references: [id])
  items    WorkOrderItem[]
  notes    WorkOrderNote[]
  payments Payment[]
  events   WorkOrderEvent[]

  @@index([tenantId])
  @@index([ownerId])
  @@index([customerId])
  @@index([vehicleId])
}

model WorkOrderItem {
  id             String           @id @default(uuid())
  tenantId       String
  workOrderId    String
  catalogItemId  String?
  type           WorkOrderItemType
  name           String
  qty            Int
  unitPriceCents Int
  lineTotalCents Int
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  workOrder WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)
  catalogItem CatalogItem? @relation(fields: [catalogItemId], references: [id])

  @@index([tenantId])
  @@index([workOrderId])
  @@index([catalogItemId])
}

model WorkOrderNote {
  id               String   @id @default(uuid())
  tenantId         String
  workOrderId      String
  note             String
  createdByUserId  String?
  createdAt        DateTime @default(now())

  workOrder WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)
  createdBy User?     @relation(fields: [createdByUserId], references: [id])

  @@index([tenantId])
  @@index([workOrderId])
  @@index([createdByUserId])
}

model Payment {
  id              String        @id @default(uuid())
  tenantId        String
  workOrderId     String
  amountCents     Int
  method          PaymentMethod
  reference       String?
  paidAt          DateTime
  createdByUserId String
  createdAt       DateTime      @default(now())

  workOrder WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)
  createdBy User      @relation(fields: [createdByUserId], references: [id])

  @@index([tenantId])
  @@index([workOrderId])
  @@index([createdByUserId])
  @@index([paidAt])
}

model CashClose {
  id              String   @id @default(uuid())
  tenantId        String
  date            String
  cashInCents     Int
  cardInCents     Int
  transferInCents Int
  notes           String?
  createdByUserId String
  createdAt       DateTime @default(now())

  createdBy User @relation(fields: [createdByUserId], references: [id])

  @@index([tenantId])
  @@index([createdByUserId])
  @@unique([tenantId, date])
}

model WorkOrderEvent {
  id              String            @id @default(uuid())
  tenantId        String
  workOrderId     String
  type            WorkOrderEventType
  payload         Json
  createdAt       DateTime          @default(now())
  createdByUserId String?

  workOrder WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)
  createdBy User?     @relation(fields: [createdByUserId], references: [id])

  @@index([tenantId])
  @@index([workOrderId])
  @@index([createdByUserId])
}

model CatalogItem {
  id              String          @id @default(uuid())
  tenantId        String
  type            CatalogItemType
  sku             String?
  name            String
  brand           String?
  unit            String
  salePriceCents  Int
  costCents       Int
  isActive        Boolean         @default(true)
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  workOrderItems     WorkOrderItem[]
  inventoryMovements InventoryMovement[]
  purchaseItems      PurchaseItem[]
  stockSnapshots     StockSnapshot[]

  @@index([tenantId])
  @@index([type])
  @@index([isActive])
}

model InventoryMovement {
  id             String               @id @default(uuid())
  tenantId       String
  catalogItemId  String
  type           InventoryMovementType
  qty            Int
  unitCostCents  Int?
  referenceType  InventoryReferenceType
  referenceId    String?
  createdByUserId String
  createdAt      DateTime             @default(now())

  catalogItem CatalogItem @relation(fields: [catalogItemId], references: [id], onDelete: Cascade)
  createdBy   User        @relation(fields: [createdByUserId], references: [id])

  @@index([tenantId])
  @@index([catalogItemId])
  @@index([referenceType])
  @@index([createdByUserId])
}

model StockSnapshot {
  catalogItemId String
  tenantId      String
  qtyOnHand     Int

  catalogItem CatalogItem @relation(fields: [catalogItemId], references: [id], onDelete: Cascade)

  @@id([catalogItemId, tenantId])
  @@index([tenantId])
}

model Supplier {
  id        String   @id @default(uuid())
  tenantId  String
  name      String
  email     String?
  phone     String?
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  purchases Purchase[]

  @@index([tenantId])
}

model Purchase {
  id         String         @id @default(uuid())
  tenantId   String
  supplierId String
  status     PurchaseStatus
  totalCents Int            @default(0)
  createdAt  DateTime       @default(now())
  updatedAt  DateTime       @updatedAt

  supplier Supplier      @relation(fields: [supplierId], references: [id])
  items    PurchaseItem[]

  @@index([tenantId])
  @@index([supplierId])
  @@index([status])
}

model PurchaseItem {
  id            String   @id @default(uuid())
  purchaseId    String
  catalogItemId String
  qty           Int
  unitCostCents Int
  lineTotalCents Int

  purchase   Purchase   @relation(fields: [purchaseId], references: [id], onDelete: Cascade)
  catalogItem CatalogItem @relation(fields: [catalogItemId], references: [id])

  @@index([purchaseId])
  @@index([catalogItemId])
}

model VehicleLookupCache {
  id           String   @id @default(uuid())
  plate        String   @unique
  responseJson Json
  fetchedAt    DateTime @default(now())

  @@index([fetchedAt])
}
